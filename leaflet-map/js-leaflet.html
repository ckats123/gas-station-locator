<!DOCTYPE html>
<html lang="en">
<head>
	<base target="_top">
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<title>Leaflet in js test</title>
	
	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
		<link rel="stylesheet" type="text/css" href="styles.css" />
		<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
		<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>


	<style>
		html, body {
			height: 100%;
			margin: 0;
		}
		.leaflet-container {
			height: 900px;
			width: 900px;
			max-width: 100%;
			max-height: 100%;
		}
	</style>

	
</head>
<body>

<div class="shape"></div>

<div id="map" style="width: 400px; height: 400px; border-radius: 50%;"></div>

<p id="autogeolocation"></p>

<script>

//if user allowed autogeolocation then initializeMapAndLocator works,
//TODO if not, then use the postal code/city to center
// } else { // some dummy default location
// 	let map = L.map('map', {
// 		zoom: 13, //TBD tie this number to react with circular button & somehow reload the map/page when pressed  
//     center: [48.407326,-123.329773]
// 	})
// }

function initializeMapAndLocator(){

var map = L.map('map')

googleStreets = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{
        zoom: 13,
        subdomains:['mt0','mt1','mt2','mt3']
    }).addTo(map);

map.locate({setView: true, 
             maxZoom: 16, 
             watch:true
           });

function onLocationFound(e) {
    var radius = e.accuracy / 2;
    L.marker(e.latlng).addTo(map)
        .bindPopup("From here").openPopup();
    L.circle(e.latlng, radius).addTo(map);
}

map.on('locationfound', onLocationFound);

}

initializeMapAndLocator();
//======================

 
	const tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    //crs: L.CRS.EPSG3347, // okay to keep default
		maxZoom: 30, //
		attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
	}).addTo(map);

	//TBD replace this section with backend data later @Feda
	// Read markers data from csv temporarily loaded on github (an excerpt of backend with 3 rows from Kitchener)
	let url = "https://raw.githubusercontent.com/ckats123/gas-station-locator/map-leaflet/leaflet-map/gas_stations.csv"
	$.get(url, function(csvString) {
	// Use PapaParse to convert string to array of objects
	let data = Papa.parse(csvString, {header: true, dynamicTyping: true}).data;
	data.sort((a,b) => b.rating - a.rating) //TBD change rating to price
	console.log(data); //checking the data is received
	//------------------------------------------------------

	// for each row of data, make marker and add it to the map
	//For each row, columns `lat`, `lng`, and `name` are required
	for (let i in data) {
		let row = data[i];
		let marker = L.marker([row.lat, row.lng], {
			opacity: 1
			})
			.addTo(map).bindPopup(`${row.name} <br> $${row.rating}/L`) //TBD change rating to price
			//,{autoClose:false, closeOnClick:false}) //this makes everything open - can't see
			.openPopup();
			//marker.addTo(map);//.openPopup(); //this works on last one
		}

});

	//check current map range in km, return result in console
	function getRangeKM(){
			var bounds = map.getBounds();

			var width = map.distance(bounds.getNorthWest(), bounds.getNorthEast()) / 1000;
			var height = map.distance(bounds.getNorthWest(), bounds.getSouthWest()) / 1000;

			return {
					width,
					height
			}
	}
	console.log(getRangeKM())

	//option to use this if query to limit results by range doesn't work.  NOT in use 
	function distance(lat1,lon1,lat2,lon2){
		var R = 6371; // km
 		return Math.acos(Math.sin(lat1)*Math.sin(lat2) + 
			Math.cos(lat1)*Math.cos(lat2) *
			Math.cos(lon2-lon1)) * R;
	}
	if (distance(station.lat, station.lon, user.lat, user.lon) <= desiredRadiusInKm){
  	// include station
	} else {
  	// exclude station
	}


//=====================
//// tried seek permission to obtain the user's location automatically w/ getCurrentPosition(). 

//	<button onclick="getLocation()">Use my device location</button>
//A call to this method asynchronously reports on the user's current location.
//set timeout in case there's no response to the request for permission 

	// let x = document.getElementById("autogeolocation");

	// const options = {
  // 	timeout: 5000
	// };

	// function getLocation() {
	// 	if (navigator.geolocation) {
	// 		navigator.geolocation.getCurrentPosition(showPosition, error, options);
	// 	} else { 
	// 		x.innerHTML = "Geolocation is not supported by this device.";
	// 	}
	// }

	// function error(err) {
  // console.warn(`ERROR(${err.code}): ${err.message}`);
	// }

	// function showPosition(position) {
	// 	x.innerHTML = "Latitude: " + position.coords.latitude + 
	// 	"<br>Longitude: " + position.coords.longitude;
	// }



	
</script>

</body>
</html>
